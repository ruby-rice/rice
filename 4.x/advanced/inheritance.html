<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Ruby C++ API" href="cpp_api.html" /><link rel="prev" title="Type Verification" href="type_verification.html" />

    <meta name="generator" content="sphinx-3.5.3, furo 2021.03.20.beta30"/>
        <title>Inheritance - Rice documentation</title>
      <link rel="stylesheet" href="../_static/styles/furo.css?digest=978e1795dfe158b585dda6a8417f6411828bf3ed">
    <link rel="stylesheet" href="../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" href="../_static/styles/furo-extensions.css?digest=d391b54134226e4196576da3bdb6dddb7e05ba2b"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Rice  documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Rice  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../advanced.html">Advanced</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="functions.html">Functions and Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory_management.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="types_overview.html">Types Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="type_conversions.html">Type Conversions</a></li>
<li class="toctree-l2"><a class="reference internal" href="type_verification.html">Type Verification</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Inheritance</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpp_api.html">Ruby C++ API</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../stl.html">STL</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../stl/stl.html">STL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/string.html">std::string</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/optional.html">std::optional</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/complex.html">std::complex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/smart_pointers.html">Smart Pointers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/pair.html">std::pair</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/vector.html">std::vector</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../migration.html">Migrating from 3 to 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../history.html">Why Rice?</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <section id="inheritance">
<h1>Inheritance<a class="headerlink" href="#inheritance" title="Permalink to this headline">¶</a></h1>
<section id="basic">
<h2>Basic<a class="headerlink" href="#basic" title="Permalink to this headline">¶</a></h2>
<p>Inheritance is a tricky problem to solve in extensions. This is because
wrapper functions for base classes typically don’t know how to accept
pointers to derived classes. It is possible to write this logic, but
the code is nontrivial.</p>
<p>Rice also provides a solution to this problem:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Base</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo</span><span class="p">();</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Derived</span>
  <span class="o">:</span> <span class="k">public</span> <span class="n">Base</span>
<span class="p">{</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="s">"C"</span>
<span class="kt">void</span> <span class="n">Init_test</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Data_Type</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;</span> <span class="n">rb_cBase</span> <span class="o">=</span>
    <span class="n">define_class</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Base"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">define_method</span><span class="p">(</span><span class="s">"foo"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Base</span><span class="o">::</span><span class="n">foo</span><span class="p">);</span>
  <span class="n">Data_Type</span><span class="o">&lt;</span><span class="n">Derived</span><span class="o">&gt;</span> <span class="n">rb_cDerived</span> <span class="o">=</span>
    <span class="n">define_class</span><span class="o">&lt;</span><span class="n">Derived</span><span class="p">,</span> <span class="n">Base</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Derived"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The second template parameter to define_class indicates that <code class="docutils literal notranslate"><span class="pre">Derived</span></code>
inherits from <code class="docutils literal notranslate"><span class="pre">Base</span></code>.</p>
<p>Rice does not support multiple inheritance.</p>
</section>
<section id="advanced">
<h2>Advanced<a class="headerlink" href="#advanced" title="Permalink to this headline">¶</a></h2>
<p>Polymorphism creates yet another wrinkle in building exceptions around C++ code,
because now we have to deal with cross-language polymorphism, where C++ can call
into a Ruby subclass, and a Ruby subclass can <code class="docutils literal notranslate"><span class="pre">super</span></code> back into C++ land. <code class="docutils literal notranslate"><span class="pre">super</span></code>
calls already work through <code class="docutils literal notranslate"><span class="pre">define_class</span></code>, but making code travel from C++ into Ruby
via polymorphism is tricker. Rice provides the <code class="docutils literal notranslate"><span class="pre">Rice::Director</span></code> class and the
<code class="docutils literal notranslate"><span class="pre">define_director</span></code> method to enable this code path.</p>
<p>Like <code class="docutils literal notranslate"><span class="pre">SWIG_Director</span></code>, <code class="docutils literal notranslate"><span class="pre">Rice::Director</span></code> is a class that is used to build a proxy class
to properly send execution up or down the object hierarchy for that class. Take
the following class:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VirtualBase</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">VirtualBase</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">doWork</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">processWorker</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Due to the abstract nature of this class, we cannot directly wrap it in Rice, as
any C++ compiler will complain about trying to instantiate a virtual class.
Even without the pure virtual function, any call to <code class="docutils literal notranslate"><span class="pre">VirtualBase::doWork</span></code> will stop
at the C++ level and execution will not pass down into any Ruby subclasses.</p>
<p>To properly wrap both of these methods, use a <code class="docutils literal notranslate"><span class="pre">Rice::Director</span></code> subclass as a proxy
and use this new proxy class as the type to wrap with <code class="docutils literal notranslate"><span class="pre">define_class</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;rice/rice.hpp&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">VirtualBaseProxy</span> <span class="o">:</span> <span class="k">public</span> <span class="n">VirtualBase</span><span class="p">,</span> <span class="k">public</span> <span class="n">Rice</span><span class="o">::</span><span class="n">Director</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">VirtualBaseProxy</span><span class="p">(</span><span class="n">Object</span> <span class="n">self</span><span class="p">)</span> <span class="o">:</span> <span class="n">Rice</span><span class="o">::</span><span class="n">Director</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">doWork</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">from_ruby</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">getSelf</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="s">"do_work"</span><span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">default_doWork</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">VirtualBase</span><span class="o">::</span><span class="n">doWork</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">processWorker</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">from_ruby</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">getSelf</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="s">"process_worker"</span><span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">default_processWorker</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">raisePureVirtual</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>There is a lot going on here, so we’ll go through each part.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VirtualBaseProxy</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Virtualbase</span><span class="p">,</span> <span class="k">public</span> <span class="n">Rice</span><span class="o">::</span><span class="n">Director</span> <span class="p">{</span> <span class="p">}</span>
</pre></div>
</div>
<p>First, the class needs to subclass both the virtual class in question and <code class="docutils literal notranslate"><span class="pre">Rice::Director</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span><span class="o">:</span>
  <span class="n">VirtualBaseProxy</span><span class="p">(</span><span class="n">Object</span> <span class="n">self</span><span class="p">)</span> <span class="o">:</span> <span class="n">Rice</span><span class="o">::</span><span class="n">Director</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</pre></div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">Rice::Director</span></code> to work its magic, every instance of this class needs to
have a handle to its Ruby instance. The constructor
must take a <code class="docutils literal notranslate"><span class="pre">Rice::Object</span></code> as the first argument and pass it up into
<code class="docutils literal notranslate"><span class="pre">Rice::Director</span></code>. The code here is the minimum required for a <code class="docutils literal notranslate"><span class="pre">Rice::Director</span></code> proxy.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span> <span class="kt">int</span> <span class="n">doWork</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">from_ruby</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">getSelf</span><span class="p">().</span><span class="n">call</span><span class="p">(</span><span class="s">"do_work"</span><span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">default_doWork</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">VirtualBase</span><span class="o">::</span><span class="n">doWork</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here the proxy class implements the virtual methods and provides implementations
that delegate execution in the correct direction. The actual method calls into Ruby,
providing all necessary type conversions to and from C++ types. The other method
is how Ruby calls back into C++ and is the method that must be exposed with
<code class="docutils literal notranslate"><span class="pre">define_method</span></code>. The <code class="docutils literal notranslate"><span class="pre">default_</span></code> prefix is a naming convention to help keep straight
which methods perform which function. If Ruby should never call into C++, then the
<code class="docutils literal notranslate"><span class="pre">default_</span></code> implementation should call <code class="docutils literal notranslate"><span class="pre">raisePureVirtual()</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">default_processWorker</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">raisePureVirtual</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">raisePureVirtual()</span></code> exists to allow wrapping a pure virtual method into Ruby
(and ensuring compliation is possible) but making sure any users of this extension are
informed quickly that there’s nothing callable in the C++ side of the library.</p>
<p>Once the proxy class is built, it’s time to wrap it into Ruby:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span> <span class="s">"C"</span>
<span class="kt">void</span> <span class="n">Init_virtual</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">define_class</span><span class="o">&lt;</span><span class="n">VirtualBase</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"VirtualBase"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">define_director</span><span class="o">&lt;</span><span class="n">VirtualBaseProxy</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="p">.</span><span class="n">define_constructor</span><span class="p">(</span><span class="n">Constructor</span><span class="o">&lt;</span><span class="n">VirtualBaseProxy</span><span class="p">,</span> <span class="n">Rice</span><span class="o">::</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">())</span>
    <span class="p">.</span><span class="n">define_method</span><span class="p">(</span><span class="s">"do_work"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">VirtualBaseProxy</span><span class="o">::</span><span class="n">default_doWork</span><span class="p">)</span>
    <span class="p">.</span><span class="n">define_method</span><span class="p">(</span><span class="s">"process_worker"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">VirtualBaseProxy</span><span class="o">::</span><span class="n">default_processWorker</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The wrapping is the same as is described earlier in this document. Expose the class
<code class="docutils literal notranslate"><span class="pre">VirtualBase</span></code>, and register <code class="docutils literal notranslate"><span class="pre">VirtualBaseProxy</span></code> as a director proxy of <code class="docutils literal notranslate"><span class="pre">VirtualBase</span></code> with
<code class="docutils literal notranslate"><span class="pre">Rice::Data_Type::define_director</span></code>, then <code class="docutils literal notranslate"><span class="pre">define_method</span></code> pointing to the proxy methods as necessary.</p>
<p>You must use the <code class="docutils literal notranslate"><span class="pre">Rice::Director</span></code> proxy class in the Constructor line, this allows proper
object construction / destruction of the types in question.</p>
</section>
</section>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="cpp_api.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Ruby C++ API</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="type_verification.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Type Verification</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, Paul Brannon, Jason Roelofs, Charlie Savage
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../_sources/advanced/inheritance.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Inheritance</a><ul>
<li><a class="reference internal" href="#basic">Basic</a></li>
<li><a class="reference internal" href="#advanced">Advanced</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>