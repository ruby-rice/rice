<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Exceptions" href="exceptions.html" /><link rel="prev" title="Iterators" href="iterators.html" />

    <!-- Generated with Sphinx 7.2.5 and Furo 2023.09.10 -->
        <title>Memory Management - Rice documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Rice  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Rice  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../bindings.html">Bindings</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Bindings</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="methods.html">Functions and Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="overloaded_methods.html">Overloaded Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="iterators.html">Iterators</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="exceptions.html">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="types_overview.html">Types Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="type_conversions.html">Type Conversions</a></li>
<li class="toctree-l2"><a class="reference internal" href="type_verification.html">Type Verification</a></li>
<li class="toctree-l2"><a class="reference internal" href="inheritance.html">Inheritance</a></li>
<li class="toctree-l2"><a class="reference internal" href="instance_registry.html">Instance Registry</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../stl.html">STL</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of STL</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../stl/stl.html">STL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/complex.html">std::complex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/map.html">std::map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/optional.html">std::optional</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/pair.html">std::pair</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/reference_wrapper.html">std::reference_wrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/smart_pointers.html">Smart Pointers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/string.html">std::string</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/string_view.html">std::string_view</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/unordered_map.html">std::unordered_map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/variant.html">std::variant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stl/vector.html">std::vector</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api.html">C++ API</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of C++ API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/overview.html">Ruby C++ API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../migration.html">Migrating from 3 to 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../history.html">Why Rice?</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="memory-management">
<span id="id1"></span><h1>Memory Management<a class="headerlink" href="#memory-management" title="Link to this heading">#</a></h1>
<p>The trickiest part of wrapping a C++ API is correctly managing memory shared between C++ and Ruby. It is critical to get this right - otherwise your program <em>will</em> crash. The key to getting it right is being crystal clear on who owns each piece of memory.</p>
<p>Rice divides native types into Builtin types and external types. Builtin types are copied between C++ and Ruby while external types are wrapped. For additional information about builtin types please refer to the <a class="reference internal" href="type_conversions.html"><span class="doc">Type Conversions</span></a> section.</p>
<p>The rest of this section discusses how to manage memory of external types.</p>
<section id="c-to-ruby">
<span id="cpp-to-ruby"></span><h2>C++ to Ruby<a class="headerlink" href="#c-to-ruby" title="Link to this heading">#</a></h2>
<p>By default Rice assumes that C++ instances passed to Ruby continue to be owned by C++. Thus there is no transfer of ownership. In this case, the transfer follows these rules:</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Method Return Type (T)</p></th>
<th class="head"><p>C++ to Ruby</p></th>
<th class="head"><p>Cleanup</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Value (T)</p></td>
<td><p>Copy constructor</p></td>
<td><p>Ruby frees the copy, C++ the original</p></td>
</tr>
<tr class="row-odd"><td><p>Reference (T&amp;)</p></td>
<td><p>No copy</p></td>
<td><p>C++ frees the C++ instance</p></td>
</tr>
<tr class="row-even"><td><p>Pointer (T*)</p></td>
<td><p>No copy</p></td>
<td><p>C++ frees the C++ instance</p></td>
</tr>
</tbody>
</table>
</div>
<p>However, many APIs transfer ownership of returned values to the caller. Thus Ruby take ownership of the value. In this case the transfer follows these rules:</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Method Return Type (T)</p></th>
<th class="head"><p>C++ to Ruby</p></th>
<th class="head"><p>Cleanup</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Value (T)</p></td>
<td><p>Copy constructor</p></td>
<td><p>Ruby frees the copy, C++ the original</p></td>
</tr>
<tr class="row-odd"><td><p>Reference (T&amp;)</p></td>
<td><p>Move constructor</p></td>
<td><p>Ruby frees the C++ instance</p></td>
</tr>
<tr class="row-even"><td><p>Pointer (T*)</p></td>
<td><p>No copy</p></td>
<td><p>Ruby frees the C++ instance</p></td>
</tr>
</tbody>
</table>
</div>
<p id="ownership">Use <a class="reference internal" href="methods.html#return"><span class="std std-ref">Return</span></a> to tell Rice that Ruby should take ownership of a returned value. Let’s look at an example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Factory</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">MyClass</span><span class="o">*</span><span class="w"> </span><span class="n">create</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyClass</span><span class="p">();;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span>
<span class="kt">void</span><span class="w"> </span><span class="n">Init_test</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Data_Type</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rb_cMyClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">define_class</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;MyClass&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">Data_Type</span><span class="o">&lt;</span><span class="n">Factory</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rb_cFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">define_class</span><span class="o">&lt;</span><span class="n">Factory</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;Factory&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="n">define_function</span><span class="p">(</span><span class="s">&quot;create&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Factory</span><span class="o">::</span><span class="n">create</span><span class="p">);</span><span class="w"> </span><span class="o">&lt;---</span><span class="w"> </span><span class="n">WRONG</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">leak</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each time <code class="docutils literal notranslate"><span class="pre">Factory#create</span></code> is called from Ruby, a new C++ instance of MyClass will be created. Using Rice’s default rules, this will result in a memory leak because those instance will never be freed.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="mi">1_000</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="n">my_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Factory</span><span class="o">.</span><span class="n">create</span>
<span class="k">end</span>
</pre></div>
</div>
<p>To fix this, you need to tell Rice that it should take ownership of the returned instance:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">define_function</span><span class="p">(</span><span class="s">&quot;create&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Factory</span><span class="o">::</span><span class="n">create</span><span class="p">,</span><span class="w"> </span><span class="n">Return</span><span class="p">().</span><span class="n">takeOwnership</span><span class="p">());</span>
</pre></div>
</div>
<p>Notice the addition of the <code class="docutils literal notranslate"><span class="pre">Return().takeOwnership()</span></code>, which creates an instance of the Return class and tells it to take ownership of the instance returned from C++.</p>
</section>
<section id="ruby-to-c">
<span id="ruby-to-cpp"></span><h2>Ruby to C++<a class="headerlink" href="#ruby-to-c" title="Link to this heading">#</a></h2>
<p>Sometimes it is necessary to tie the lifetime of one Ruby object to another. This often times happens with containers. For example, imagine we have a <code class="docutils literal notranslate"><span class="pre">Listener</span></code> and a <code class="docutils literal notranslate"><span class="pre">ListenerContainer</span></code> class.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Listener</span>
<span class="p">{</span>
<span class="p">};</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ListenerContainer</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">addListener</span><span class="p">(</span><span class="n">Listener</span><span class="o">*</span><span class="w"> </span><span class="n">listener</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">mListeners</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">process</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Listener</span><span class="o">&amp;</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mListeners</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Listener</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">mListeners</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Assuming these classes are wrapped with Rice, the following code crash:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="vi">@handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ListenerContainer</span><span class="o">.</span><span class="n">new</span>
<span class="vi">@handler</span><span class="o">.</span><span class="n">add_listener</span><span class="p">(</span><span class="no">Listener</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
<span class="no">GC</span><span class="o">.</span><span class="n">start</span>
<span class="vi">@handler</span><span class="o">.</span><span class="n">process</span><span class="w"> </span><span class="o">!!!!</span><span class="w"> </span><span class="n">crash</span><span class="w"> </span><span class="o">!!!!!</span>
</pre></div>
</div>
<p>The Ruby garbage collector will notice that the <code class="docutils literal notranslate"><span class="pre">Listener.new</span></code> object is orphaned and will free it. That it turn frees the underlying C++ Listener object resulting in a crash when <code class="docutils literal notranslate"><span class="pre">process</span></code> is called.</p>
<p>To prevent this, we want to tie the lifetime of the Ruby listener instance to the container. This is done by calling <code class="docutils literal notranslate"><span class="pre">keepAlive()</span></code> in the argument list:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">define_class</span><span class="o">&lt;</span><span class="no">ListenerContainer</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">&quot;ListenerContainer&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="o">.</span><span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;add_listener&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="no">ListenerContainer</span><span class="o">::</span><span class="n">addListener</span><span class="p">,</span><span class="w"> </span><span class="no">Arg</span><span class="p">(</span><span class="s2">&quot;listener&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">keepAlive</span><span class="p">())</span>
</pre></div>
</div>
<p>With this change, when a listener is added to the container, the container keeps a reference to it and will call <code class="docutils literal notranslate"><span class="pre">rb_gc_mark</span></code> to keep it alive. This is exactly the same thing Ruby’s collection classes, such as Arrays and Hashes, do. The <code class="docutils literal notranslate"><span class="pre">Listener</span></code> object will not be freed until the container itself goes out of scope.</p>
<p>Another example is when a returned object is dependent upon the original object. For example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Column</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Database</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Database</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// connect to Database</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="o">~</span><span class="n">Database</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// disconnect from database</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">Column</span><span class="w"> </span><span class="n">getColumn</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">Column</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">looupName</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">some_name</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Column</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Column</span><span class="p">(</span><span class="n">Database</span><span class="o">&amp;</span><span class="w"> </span><span class="n">database</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">database_</span><span class="p">(</span><span class="n">database</span><span class="p">),</span><span class="w"> </span><span class="n">index_</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">Column</span><span class="w"> </span><span class="n">getName</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">database</span><span class="p">.</span><span class="n">lookupName</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">index_</span><span class="p">)</span><span class="o">:</span>
<span class="w">  </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="n">Database</span><span class="o">&amp;</span><span class="w"> </span><span class="n">database_</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">index_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Assuming these classes are wrapped with Rice, then the following Ruby code will crash:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_column</span><span class="p">(</span><span class="n">column_index</span><span class="p">)</span>
<span class="w">  </span><span class="n">database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Database</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="w">  </span><span class="n">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">column_index</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_column</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">puts</span><span class="w"> </span><span class="n">column</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>The problem is that the instance of the Database class created in <code class="docutils literal notranslate"><span class="pre">get_column</span></code> will likely be garbage collected when the method returns. As a result, when <code class="docutils literal notranslate"><span class="pre">Column#name</span></code> is called it will have a dangling reference to the no longer valid database object.</p>
<p>Obviously this code could be rewritten to make sure the database object remains alive throughout the program. Alternatively, you can tell Rice that to tie the lifetime of the Database object to the Column object so that it will not be freed until the Column is freed:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">define_class</span><span class="o">&lt;</span><span class="no">Database</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">&quot;Database&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="o">.</span><span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;get_column&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="no">Database</span><span class="o">::</span><span class="n">getColumn</span><span class="p">,</span><span class="w"> </span><span class="no">Return</span><span class="p">()</span><span class="o">.</span><span class="n">keepAlive</span><span class="p">())</span>
</pre></div>
</div>
<p>Note that Return().keepAlive() will work with external types only. An attempt to use it with builtin type will result in runtime exception.</p>
</section>
<section id="c-referencing-ruby-objects">
<h2>C++ Referencing Ruby Objects<a class="headerlink" href="#c-referencing-ruby-objects" title="Link to this heading">#</a></h2>
<p>When reference Ruby objects from C++, you need to let Ruby know about them so they are not prematurely garbage collected.</p>
<p>There are several ways this can happen:</p>
<section id="stack">
<h3>Stack<a class="headerlink" href="#stack" title="Link to this heading">#</a></h3>
<p>If you are working with VALUEs or Objects stored on the stack, the Ruby garbage collector will try to find them automatically. However, optimizing compilers may prevent them from doing so. Thus you may need to use Ruby’s <a class="reference external" href="https://docs.ruby-lang.org/en/3.2/extension_rdoc.html#label-Appendix+E.+RB_GC_GUARD+to+protect+from+premature+GC">RB_GC_GUARD</a> macro</p>
</section>
<section id="heap">
<h3>Heap<a class="headerlink" href="#heap" title="Link to this heading">#</a></h3>
<p>If you allocate an Object on the heap or if it is a member of an object that might be allocated on the heap, use <code class="docutils literal notranslate"><span class="pre">Rice::Address_Registration_Guard</span></code> to register the object with the garbage collector.</p>
</section>
<section id="member-variables">
<h3>Member Variables<a class="headerlink" href="#member-variables" title="Link to this heading">#</a></h3>
<p>If you create classes or structures that reference Ruby objects, you need to implement a custom <code class="docutils literal notranslate"><span class="pre">ruby_mark</span></code> function:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">VALUE</span><span class="w"> </span><span class="n">value_</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">Rice</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="w">  </span><span class="n">ruby_mark</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MyClass</span><span class="o">*</span><span class="w"> </span><span class="n">myClass</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">rb_gc_mark</span><span class="p">(</span><span class="n">myClass</span><span class="o">-&gt;</span><span class="n">value_</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">Data_Type</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">define_class</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;MyClass&quot;</span><span class="p">)</span>
<span class="w">          </span><span class="p">.</span><span class="n">define_constructor</span><span class="p">(</span><span class="n">Constructor</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="p">());</span>
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="exceptions.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Exceptions</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="iterators.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Iterators</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Paul Brannon, Jason Roelofs, Charlie Savage
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Memory Management</a><ul>
<li><a class="reference internal" href="#c-to-ruby">C++ to Ruby</a></li>
<li><a class="reference internal" href="#ruby-to-c">Ruby to C++</a></li>
<li><a class="reference internal" href="#c-referencing-ruby-objects">C++ Referencing Ruby Objects</a><ul>
<li><a class="reference internal" href="#stack">Stack</a></li>
<li><a class="reference internal" href="#heap">Heap</a></li>
<li><a class="reference internal" href="#member-variables">Member Variables</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>